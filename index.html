<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>リンクリスト — Material Web (list.xml固定)</title>

  <!-- Material Web (esm.run CDN) -->
  <script type="importmap">
  {
    "imports": {
      "@material/web/": "https://esm.run/@material/web/"
    }
  }
  </script>
  <script type="module">
    import '@material/web/all.js';
  </script>

  <style>
    :root{ --maxw:980px; font-family: system-ui, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Roboto, sans-serif; }
    body{ background:#f5f7fb; margin:0; padding:28px; color:#111827; }
    .wrap{ max-width:var(--maxw); margin:0 auto; }
    header{ display:flex; gap:12px; align-items:center; }
    h1{ margin:0; font-size:1.25rem; }
    .controls{ margin-left:auto; display:flex; gap:10px; align-items:center; }
    .list{ margin-top:18px; display:grid; gap:12px; }
    md-card{ display:flex; justify-content:space-between; align-items:flex-start; padding:12px; }
    .meta{ flex:1; padding-right:12px; }
    .title-row{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .desc{ color:#555; margin:8px 0; }
    .tags{ display:flex; flex-wrap:wrap; gap:8px; }
    md-chip{ cursor:pointer; }
    .right{ min-width:120px; display:flex; align-items:center; }
    .status{ margin-top:12px; color:#6b7280; }
    .empty{ padding:18px; background:white; border-radius:12px; text-align:center; }
    md-filled-select, md-outlined-text-field{ min-width:160px; }
    @media (max-width:640px){ header{flex-direction:column; align-items:flex-start} .controls{ margin-left:0; }
      .right{ min-width:100px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="controls">
        <md-outlined-text-field id="search" placeholder="検索（タイトル・説明・タグ）"></md-outlined-text-field>

        <!-- タグ絞り込み（ドロップダウン） -->
        <md-filled-select id="tagFilter" label="タグで絞り込み">
          <md-select-option value="" selected>すべて</md-select-option>
        </md-filled-select>

        <!-- 並び替え -->
        <md-filled-select id="sort" label="並び替え">
          <md-select-option value="title_asc" selected>タイトル昇順</md-select-option>
          <md-select-option value="title_desc">タイトル降順</md-select-option>
          <md-select-option value="tagcount_desc">タグ数降順</md-select-option>
        </md-filled-select>

        <md-filled-button id="reload">再読み込み</md-filled-button>
      </div>
    </header>

    <div id="status" class="status">読み込み中...</div>

    <div id="list" class="list" aria-live="polite"></div>
  </div>

  <script>
  const XML_PATH = 'list.xml';

  const statusEl = document.getElementById('status');
  const listEl = document.getElementById('list');
  const searchInput = document.getElementById('search');
  const tagFilter = document.getElementById('tagFilter');
  const sortSelect = document.getElementById('sort');
  const reloadBtn = document.getElementById('reload');

  let LINKS = [];

  function textOf(node, tagName){
    const el = node.querySelector(tagName);
    return el ? (el.textContent || '').trim() : '';
  }

  function unique(array){ return [...new Set(array)]; }

  async function loadXml(){
    setStatus('読み込み中...');
    try{
      const resp = await fetch(XML_PATH, {cache:'no-store'});
      if(!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
      const txt = await resp.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(txt, 'application/xml');
      const parsererror = xml.querySelector('parsererror');
      if(parsererror) throw new Error('XML 解析エラー: ' + parsererror.textContent);

      let nodes = Array.from(xml.querySelectorAll('link'));
      if(nodes.length === 0) nodes = Array.from(xml.querySelectorAll('item'));

      LINKS = nodes.map(n => ({
        title: textOf(n,'title') || '(タイトルなし)',
        url: textOf(n,'url') || textOf(n,'link') || '#',
        description: textOf(n,'description'),
        tags: (textOf(n,'tags') || textOf(n,'tag') || '').split(',').map(s=>s.trim()).filter(Boolean)
      }));

      setStatus(`読み込み完了：${LINKS.length} 件`);
      buildTagFilter();
      render();
    }catch(err){
      console.error(err);
      setStatus('エラー: ' + err.message);
      listEl.innerHTML = `<div class="empty">list.xml の読み込みに失敗しました。コンソールを確認してください。</div>`;
    }
  }

  function setStatus(text){ statusEl.textContent = text; }

  function buildTagFilter(){
    const allTags = LINKS.flatMap(l=>l.tags);
    const uniq = unique(allTags).sort((a,b)=>a.localeCompare(b));

    while(tagFilter.firstChild) tagFilter.removeChild(tagFilter.firstChild);
    const defaultItem = document.createElement('md-select-option');
    defaultItem.setAttribute('value','');
    defaultItem.textContent = 'すべて';
    tagFilter.appendChild(defaultItem);

    uniq.forEach(tag => {
      const it = document.createElement('md-select-option');
      it.setAttribute('value', tag);
      it.textContent = `${tag}`;
      tagFilter.appendChild(it);
    });
  }

  function render(){
    const q = (searchInput.value || '').toLowerCase().trim();
    const tag = tagFilter.value;
    const sortMode = sortSelect.value;

    let arr = LINKS.filter(item => {
      const text = (item.title + ' ' + item.description + ' ' + item.tags.join(' ')).toLowerCase();
      if(q && !text.includes(q)) return false;
      if(tag && !item.tags.includes(tag)) return false;
      return true;
    });

    if(sortMode === 'title_asc') arr.sort((a,b)=> a.title.localeCompare(b.title));
    else if(sortMode === 'title_desc') arr.sort((a,b)=> b.title.localeCompare(a.title));
    else if(sortMode === 'tagcount_desc') arr.sort((a,b)=> b.tags.length - a.tags.length);

    if(arr.length === 0){ listEl.innerHTML = `<div class="empty">該当するリンクがありません。</div>`; return; }

    listEl.innerHTML = '';
    arr.forEach(item => {
      const card = document.createElement('md-card');
      const meta = document.createElement('div'); meta.className = 'meta';

      const titleRow = document.createElement('div'); titleRow.className = 'title-row';
      const a = document.createElement('a'); a.href = item.url; a.textContent = item.title; a.target = '_blank'; a.rel = 'noopener noreferrer';
      const right = document.createElement('div'); right.className = 'right';

      const openBtn = document.createElement('md-filled-button');
      openBtn.innerHTML = '開く';
      openBtn.addEventListener('click', ()=> window.open(item.url, '_blank'));

      titleRow.appendChild(a);
      right.appendChild(openBtn);

      const desc = document.createElement('div'); desc.className = 'desc'; desc.textContent = item.description || '';
      const tagsDiv = document.createElement('div'); tagsDiv.className = 'tags';

      (item.tags || []).forEach(t => {
        const chip = document.createElement('md-chip');
        chip.setAttribute('removable','false');
        chip.textContent = t;
        chip.addEventListener('click', ()=>{ tagFilter.value = t; render(); });
        tagsDiv.appendChild(chip);
      });

      meta.appendChild(titleRow);
      meta.appendChild(desc);
      meta.appendChild(tagsDiv);

      card.appendChild(meta);
      card.appendChild(right);
      listEl.appendChild(card);
    });
  }

  searchInput.addEventListener('input', debounce(render, 200));
  tagFilter.addEventListener('change', render);
  sortSelect.addEventListener('change', render);
  reloadBtn.addEventListener('click', loadXml);

  function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

  // ページアクセス時に自動で読み込む
  window.addEventListener('DOMContentLoaded', loadXml);
  </script>
</body>
</html>
